image: docker:latest
services:
  - docker:dind

stages:
  - test
  - build
  - release

Test with SonarCloud:
  stage: test
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  script:
    - > 
      sonar-scanner 
      -Dsonar.qualitygate.wait=true 
      -Dsonar.projectKey="gezm0_internship_diploma" 
      -Dsonar.python.version=3.9 
      -Dsonar.organization="gezm0"
  allow_failure: true

Build infra apps:
  stage: build
  script:
    - cd app_infra
    - docker build -f Dockerfile_db_create_tables -t $CI_REGISTRY_IMAGE:db_create_$CI_COMMIT_SHORT_SHA .
    - docker build -f Dockerfile_db_drop_tables -t $CI_REGISTRY_IMAGE:db_drop_$CI_COMMIT_SHORT_SHA .

Build application:
  stage: build
  script:
    - docker build -t $CI_REGISTRY_IMAGE:app_back_$CI_COMMIT_SHORT_SHA app_back
    - docker build -t $CI_REGISTRY_IMAGE:app_front_$CI_COMMIT_SHORT_SHA app_front

Release:
  stage: release
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
    - docker push $CI_REGISTRY_IMAGE:db_create_$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:db_drop_$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:app_back_$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:app_front_$CI_COMMIT_SHORT_SHA
